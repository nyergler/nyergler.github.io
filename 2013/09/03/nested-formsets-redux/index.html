<!doctype html><html lang=en><head>
<meta charset=utf-8>
<meta http-equiv=content-language content="en">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge">
<title>Revisiting Nested Formsets &#183; Nathan R. Yergler</title>
<meta name=title content="Revisiting Nested Formsets &#183; Nathan R. Yergler">
<meta name=description content>
<link rel=canonical href=https://nyergler.github.io/2013/09/03/nested-formsets-redux/>
<link type=text/css rel=stylesheet href=/css/schemes/ocean.min.ff17c50528c7a4a8a8bb8ec41272d63eb936ecefb9ccfa6db45cd1f5cd8b1becf8606745f751ee0d322ac80c9cb96e58aa699b38aa44cff9d2a8b3ff4f05a7b5.css integrity="sha512-/xfFBSjHpKiou47EEnLWPrk27O+5zPpttFzR9c2LG+z4YGdF91HuDTIqyAycuW5YqmmbOKpEz/nSqLP/TwWntQ==">
<link type=text/css rel=stylesheet href=/css/compiled/main.min.84c4218572228cacf6182dc59fe08b5e1bcd599bb583bc56976aa0070f4cd8a4ff130ee2313074359bf6dba03b211e8c50df743d84ad551575fd0b9f849ec802.css integrity="sha512-hMQhhXIijKz2GC3Fn+CLXhvNWZu1g7xWl2qgBw9M2KT/Ew7iMTB0NZv226A7IR6MUN90PYStVRV1/QufhJ7IAg==">
<script>function loadPreferredAppearance(){localStorage.preferredAppearance==="dark"||!("preferredAppearance"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function setPreferredAppearance(a){a=="default"?localStorage.removeItem("preferredAppearance"):localStorage.preferredAppearance=a,loadPreferredAppearance()}loadPreferredAppearance(),window.matchMedia("(prefers-color-scheme: dark)").addListener(loadPreferredAppearance)</script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<meta property="og:title" content="Revisiting Nested Formsets">
<meta property="og:description" content="It’s been nearly four years since I first wrote about nested formsets .">
<meta property="og:type" content="article">
<meta property="og:url" content="https://nyergler.github.io/2013/09/03/nested-formsets-redux/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2013-09-03T00:00:00+00:00">
<meta property="article:modified_time" content="2013-09-03T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Revisiting Nested Formsets">
<meta name=twitter:description content="It’s been nearly four years since I first wrote about nested formsets .">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","articleSection":"Posts","name":"Revisiting Nested Formsets","headline":"Revisiting Nested Formsets","description":"It’s been nearly four years since I first wrote about nested formsets .","inLanguage":"en","author":{"@type":"Person","name":"Nathan Yergler"},"creator":{"@type":"Person","name":"Nathan Yergler"},"copyrightHolder":"Nathan Yergler","copyrightYear":"2013","dateCreated":"2013-09-03T00:00:00\u002b00:00","datePublished":"2013-09-03T00:00:00\u002b00:00","dateModified":"2013-09-03T00:00:00\u002b00:00","url":"https:\/\/nyergler.github.io\/2013\/09\/03\/nested-formsets-redux\/","wordCount":"957","keywords":["django","forms","formsets","python"]}</script>
<meta name=author content="Nathan Yergler">
<link href=https://github.com/nyergler rel=me>
<link href=https://instagram.com/nyergler rel=me>
</head>
<body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><header class="flex justify-between py-6 font-semibold sm:items-center sm:py-10 text-neutral-900 dark:text-neutral">
<div>
<a class="hover:underline hover:underline-primary-500 hover:underline-thickness-bold hover:underline-offset-small" rel=me href=/>Nathan R. Yergler</a>
</div>
<nav>
<ul class="flex flex-col list-none sm:flex-row">
<li class="mb-1 text-right sm:mb-0 sm:mr-7 sm:last:mr-0">
<a class="hover:underline hover:underline-primary-500 hover:underline-thickness-bold hover:underline-offset-small" href=/about/ title="Oh hai.">Bio</a>
</li>
<li class="mb-1 text-right sm:mb-0 sm:mr-7 sm:last:mr-0">
<a class="hover:underline hover:underline-primary-500 hover:underline-thickness-bold hover:underline-offset-small" href=/posts/ title=Posts>Blog</a>
</li>
<li class="mb-1 text-right sm:mb-0 sm:mr-7 sm:last:mr-0">
<a class="hover:underline hover:underline-primary-500 hover:underline-thickness-bold hover:underline-offset-small" href=/prints/ title=Prints>Prints</a>
</li>
</ul>
</nav>
</header>
<main class=flex-grow>
<article class=max-w-prose>
<header>
<ol class="text-sm text-neutral-500 dark:text-neutral-400">
<li class="inline hidden">
<a class="hover:underline hover:underline-neutral-300 dark:underline-neutral-600" href=/>Nathan R. Yergler</a><span class="px-1 text-primary-500">/</span>
</li>
<li class=inline>
<a class="hover:underline hover:underline-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span>
</li>
<li class="inline hidden">
<a class="hover:underline hover:underline-neutral-300 dark:underline-neutral-600" href=/2013/09/03/nested-formsets-redux/>Revisiting Nested Formsets</a><span class="px-1 text-primary-500">/</span>
</li>
</ol>
<h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
Revisiting Nested Formsets
</h1>
<div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400">
<div class="flex flex-row items-center">
<time datetime="2013-09-03 00:00:00 +0000 UTC">3 September 2013</time>
</div>
</div>
</header>
<section class="prose dark:prose-light">
<p>It’s been nearly four years since I first wrote about <a href=http://yergler.net/blog/2009/09/27/nested-formsets-with-django/>nested formsets</a> . When I wrote about nested formsets, I must have been using Django 1.1 (based on correlating dates in the <a href=https://docs.djangoproject.com/en/1.5/releases/>release notes</a> and the original blog post), which means what I wrote has had four major releases of Django to drift out of date. And yet it’s still one of the most frequently visited posts on my blog, and one of the few that I receive email questions about. Four years later, it seemed like the time to revisit the original post to see if nested formsets still make sense and if so, what they look like now.</p>
<p><a href=https://docs.djangoproject.com/en/1.5/topics/forms/formsets/>Formsets</a> help manage the complexity of maintaining multiple instances of a <a href=https://docs.djangoproject.com/en/1.5/topics/forms/>Form</a> on a single page. For example, if you’re editing a list of items on a single page, each individual item may be a copy of the same form. Formsets help manage things like <span class=caps>HTML</span> <span class=caps>ID</span> generation, flagging forms for deletion, and validating the entire set of forms together. When used with <a href=https://docs.djangoproject.com/en/1.5/topics/db/models/>Models</a> , they allow you to edit the members of a <a href=https://docs.djangoproject.com/en/1.5/ref/models/querysets/>QuerySet</a> all at once.</p>
<p>So what are nested formsets? The example I used previously was something along the lines of Block – Building – Tenant: one Block has many Buildings, and each Building has many Tenants. If you’re editing a Block, you want to see all the Buildings and all the Tenants at once. That’s a fine hypothetical, but one of the questions I get with some frequency is “what’s a good use case for a nested formset?” Four years later — two and a half of them spent doing web development full time — I have yet to encounter a situation where I needed a nested formset. In that time I’ve built some pretty complex forms, including Eventbrite’s <a href=http://blog.eventbrite.com/create-your-event-pages-faster-and-easier/>event creation flow</a> . That page was complex enough that I built <a href=https://github.com/eventbrite/rebar/blob/master/src/rebar/group.py>Form Groups</a> to support the interaction, and I think the jury is still out on whether that was a good idea or not. It’s possible that there are use cases for nested formsets in admin-style applications that I haven’t encountered. I think it’s also possible that there are reasons to use a nested formset alongside a Javascript framework to ease the user experience.</p>
<p>Note that if you only have one level of relationships on the page (ie, you’re editing all the Tenants for a single Building in our example) then you don’t need nested formsets: Django’s <a href=https://docs.djangoproject.com/en/1.5/topics/forms/modelforms/#inline-formsets>inline formsets</a> will work just fine.</p>
<p>And why not nested form sets? From the questions people have asked and my experience building Form Groups (which borrowed some ideas), I’ve concluded that they’re difficult to get completely right, have edge cases that can be hard to manage, and create quite complicated user interfaces. In my original blog post I alluded to the fact that I spent most of a three day weekend trying to get the nested formsets to work right. Two thirds of that time was spent on work I eventually threw away, because I couldn’t manage the edge cases. It was only when I started using <span class=caps>TDD</span> that I managed to get something working. But I didn’t publish the tests with my previous code example, so no one else was able to benefit from that work.</p>
<p>If you’ve read this far and still think a nested formset is the best solution for your problem, what would that look like with Django 1.5? The answer is: simpler. I decided to rewrite my initial implementation using test driven development. The full implementation of the formset logic only overrides three methods from <tt class="docutils literal">BaseInlineFormSet</tt>.</p>
<pre class="code python literal-block"><span class=kn>from</span> <span class=nn>django.forms.models</span> <span class=kn>import</span> <span class=p>(</span>
    <span class=n>BaseInlineFormSet</span><span class=p>,</span>
    <span class=n>inlineformset_factory</span><span class=p>,</span>
<span class=p>)</span>


<span class=k>class</span> <span class=nc>BaseNestedFormset</span><span class=p>(</span><span class=n>BaseInlineFormSet</span><span class=p>):</span>

    <span class=k>def</span> <span class=nf>add_fields</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>form</span><span class=p>,</span> <span class=n>index</span><span class=p>):</span>

        <span class=c1># allow the super class to create the fields as usual</span>
        <span class=nb>super</span><span class=p>(</span><span class=n>BaseNestedFormset</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>add_fields</span><span class=p>(</span><span class=n>form</span><span class=p>,</span> <span class=n>index</span><span class=p>)</span>

        <span class=n>form</span><span class=o>.</span><span class=n>nested</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nested_formset_class</span><span class=p>(</span>
            <span class=n>instance</span><span class=o>=</span><span class=n>form</span><span class=o>.</span><span class=n>instance</span><span class=p>,</span>
            <span class=n>data</span><span class=o>=</span><span class=n>form</span><span class=o>.</span><span class=n>data</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_bound</span> <span class=k>else</span> <span class=bp>None</span><span class=p>,</span>
            <span class=n>prefix</span><span class=o>=</span><span class=s1>'</span><span class=si>%s</span><span class=s1>-</span><span class=si>%s</span><span class=s1>'</span> <span class=o>%</span> <span class=p>(</span>
                <span class=n>form</span><span class=o>.</span><span class=n>prefix</span><span class=p>,</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>nested_formset_class</span><span class=o>.</span><span class=n>get_default_prefix</span><span class=p>(),</span>
            <span class=p>),</span>
        <span class=p>)</span>

    <span class=k>def</span> <span class=nf>is_valid</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>

        <span class=n>result</span> <span class=o>=</span> <span class=nb>super</span><span class=p>(</span><span class=n>BaseNestedFormset</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>is_valid</span><span class=p>()</span>

        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_bound</span><span class=p>:</span>
            <span class=c1># look at any nested formsets, as well</span>
            <span class=k>for</span> <span class=n>form</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>forms</span><span class=p>:</span>
                <span class=n>result</span> <span class=o>=</span> <span class=n>result</span> <span class=ow>and</span> <span class=n>form</span><span class=o>.</span><span class=n>nested</span><span class=o>.</span><span class=n>is_valid</span><span class=p>()</span>

        <span class=k>return</span> <span class=n>result</span>

    <span class=k>def</span> <span class=nf>save</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>commit</span><span class=o>=</span><span class=bp>True</span><span class=p>):</span>

        <span class=n>result</span> <span class=o>=</span> <span class=nb>super</span><span class=p>(</span><span class=n>BaseNestedFormset</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>commit</span><span class=o>=</span><span class=n>commit</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>form</span> <span class=ow>in</span> <span class=bp>self</span><span class=p>:</span>
            <span class=n>form</span><span class=o>.</span><span class=n>nested</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>commit</span><span class=o>=</span><span class=n>commit</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>result</span>
</pre>
<p>These three method cover the four areas of functionality I called out in the <a href=http://yergler.net/blog/2009/09/27/nested-formsets-with-django/>previous post</a> : validation (<tt class="docutils literal">is_valid</tt>), saving (both existing and new objects are handled here by <tt class="docutils literal">save</tt>), and instantiation (creating the nested formset instances, handled by <tt class="docutils literal">add_fields</tt>).</p>
<p>By making it a general purpose baseclass, I’m also able to write a simple factory function, to make using it more in tune with Django’s built-in model formset.</p>
<pre class="code python literal-block"><span class=k>def</span> <span class=nf>nested_formset_factory</span><span class=p>(</span><span class=n>parent_model</span><span class=p>,</span> <span class=n>child_model</span><span class=p>,</span> <span class=n>grandchild_model</span><span class=p>):</span>

    <span class=n>parent_child</span> <span class=o>=</span> <span class=n>inlineformset_factory</span><span class=p>(</span>
        <span class=n>parent_model</span><span class=p>,</span>
        <span class=n>child_model</span><span class=p>,</span>
        <span class=n>formset</span><span class=o>=</span><span class=n>BaseNestedFormset</span><span class=p>,</span>
    <span class=p>)</span>

    <span class=n>parent_child</span><span class=o>.</span><span class=n>nested_formset_class</span> <span class=o>=</span> <span class=n>inlineformset_factory</span><span class=p>(</span>
        <span class=n>child_model</span><span class=p>,</span>
        <span class=n>grandchild_model</span><span class=p>,</span>
    <span class=p>)</span>

    <span class=k>return</span> <span class=n>parent_child</span>
</pre>
<p>You can find the source to this <a href=https://github.com/nyergler/nested-formset>general purpose implementation on GitHub</a> . I wrote tests at each step as I worked on this, so it may be interesting to go back and look at individual commits, as well.</p>
<p>So how would you use this in with Django 1.5? With a <a href=https://docs.djangoproject.com/en/1.5/topics/class-based-views/>class-based view</a> , of course.</p>
<pre class="code python literal-block"><span class=kn>from</span> <span class=nn>django.views.generic.edit</span> <span class=kn>import</span> <span class=n>UpdateView</span>

<span class=k>class</span> <span class=nc>EditBuildingsView</span><span class=p>(</span><span class=n>UpdateView</span><span class=p>):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>Block</span>

    <span class=k>def</span> <span class=nf>get_template_names</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>

        <span class=k>return</span> <span class=p>[</span><span class=s1>'blocks/building_form.html'</span><span class=p>]</span>

    <span class=k>def</span> <span class=nf>get_form_class</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>

        <span class=k>return</span> <span class=n>nested_formset_factory</span><span class=p>(</span>
            <span class=n>models</span><span class=o>.</span><span class=n>Block</span><span class=p>,</span>
            <span class=n>models</span><span class=o>.</span><span class=n>Building</span><span class=p>,</span>
            <span class=n>models</span><span class=o>.</span><span class=n>Tenant</span><span class=p>,</span>
        <span class=p>)</span>

    <span class=k>def</span> <span class=nf>get_success_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>

        <span class=k>return</span> <span class=n>reverse</span><span class=p>(</span><span class=s1>'blocks-list'</span><span class=p>)</span>
</pre>
<p>Of course there’s more needed — templates, for one — but this shows just how easy it is to create the views and leverage a generic abstraction. The real keys here are specifying <tt class="docutils literal">model = models.Block</tt> and the definition of <tt class="docutils literal">get_form_class</tt>. Django’s <a href=https://docs.djangoproject.com/en/1.5/ref/class-based-views/generic-editing/#updateview>UpdateView</a> knows how to implement the basic form processing idiom (<span class=caps>GET</span>, <span class=caps>POST</span>, redirect), so all you need to do is tell it which form to use.</p>
<p>You can find a functional, albeit ugly, demo application in the <tt class="docutils literal">demo</tt> directory of the <a href=https://github.com/nyergler/nested-formset>git repository</a> .</p>
<p>So that’s it: a general purpose, updated implementation of nested formsets. I advise using them sparingly :).</p>
</section>
<footer class=pt-8>
<div class="pt-8 article-pagination">
<hr class="border-dotted border-neutral-300 dark:border-neutral-600">
<div class="flex justify-between pt-3">
<span>
<a class=flex href=/2014/02/19/docsix-doctests-python-3/>
<span class="mr-3 article-pagination-direction">&larr;</span>
<span class="flex flex-col">
<span class="article-pagination-title mt-[0.1rem] leading-6">
DocSix: Doctests on Python 2 & 3</span>
<span class="mt-[0.1rem] text-xs text-neutral-400 dark:text-neutral-500">
<time datetime="2014-02-19 00:00:00 +0000 UTC">19 February 2014</time>
</span>
</span>
</a>
</span>
<span>
<a class="flex text-right" href=/2013/08/17/destroyed-0003/>
<span class="flex flex-col">
<span class="article-pagination-title mt-[0.1rem] leading-6">Destroyed 0003</span>
<span class="mt-[0.1rem] text-xs text-neutral-400 dark:text-neutral-500">
<time datetime="2013-08-17 00:00:00 +0000 UTC">17 August 2013</time>
</span>
</span>
<span class="ml-3 article-pagination-direction">&rarr;</span>
</a>
</span>
</div>
</div>
</footer>
</article>
</main><footer class=py-10>
<nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
<ul class="flex flex-col list-none sm:flex-row">
<li class="mb-1 sm:mb-0 sm:mr-7 sm:last:mr-0">
<a class="hover:underline hover:underline-primary-500 hover:underline-thickness-bold hover:underline-offset-small" href=/tags/ title=Tags>Tags</a>
</li>
<li class="mb-1 sm:mb-0 sm:mr-7 sm:last:mr-0">
<a class="hover:underline hover:underline-primary-500 hover:underline-thickness-bold hover:underline-offset-small" href=/categories/ title=Categories>Categories</a>
</li>
</ul>
</nav>
<div class="flex justify-between">
<div>
<p class="text-sm text-neutral-500 dark:text-neutral-400">
&copy;
2022
Nathan Yergler
</p>
</div>
</div>
</footer>
</body>
</html>