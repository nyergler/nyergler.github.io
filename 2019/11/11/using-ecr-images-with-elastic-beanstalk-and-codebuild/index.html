<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Using ECR images with Elastic Beanstalk and CodeBuild &#183; Nathan R. Yergler</title><meta name=title content="Using ECR images with Elastic Beanstalk and CodeBuild &#183; Nathan R. Yergler"><link rel=canonical href=https://nyergler.github.io/2019/11/11/using-ecr-images-with-elastic-beanstalk-and-codebuild/><link type=text/css rel=stylesheet href=/css/main.bundle.min.4735e28405aff4160bd59ccda70d9a096bb5a4eb5f151bfdaaa0deebdfc5bf5083b144fc72ddc5c3a008c29d8709d081655db7a60d3e64d4176446438871a276.css integrity="sha512-RzXihAWv9BYL1ZzNpw2aCWu1pOtfFRv9qqDe69/Fv1CDsUT8ct3Fw6AIwp2HCdCBZV23pg0+ZNQXZEZDiHGidg=="><script type=text/javascript src=/js/appearance.min.12e98742cd283574d030a7fe55f29597df4ee214f7ff7075b4d19a64d046a602753c715295550be7899b661619cec89c679049d36c624681671a8013c1249896.js integrity="sha512-EumHQs0oNXTQMKf+VfKVl99O4hT3/3B1tNGaZNBGpgJ1PHFSlVUL54mbZhYZzsicZ5BJ02xiRoFnGoATwSSYlg=="></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Using ECR images with Elastic Beanstalk and CodeBuild"><meta property="og:description" content="As I mentioned previously, I&rsquo;ve been using CodePipeline and CodeBuild for continuous integration and delivery on a new project."><meta property="og:type" content="article"><meta property="og:url" content="https://nyergler.github.io/2019/11/11/using-ecr-images-with-elastic-beanstalk-and-codebuild/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-11-11T17:11:11+00:00"><meta property="article:modified_time" content="2019-11-11T17:11:11+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using ECR images with Elastic Beanstalk and CodeBuild"><meta name=twitter:description content="As I mentioned previously, I&rsquo;ve been using CodePipeline and CodeBuild for continuous integration and delivery on a new project."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Using ECR images with Elastic Beanstalk and CodeBuild","headline":"Using ECR images with Elastic Beanstalk and CodeBuild","abstract":"As I mentioned previously, I\u0026rsquo;ve been using CodePipeline and CodeBuild for continuous integration and delivery on a new project.","inLanguage":"en","url":"https:\/\/nyergler.github.io\/2019\/11\/11\/using-ecr-images-with-elastic-beanstalk-and-codebuild\/","author":{"@type":"Person","name":"Nathan Yergler"},"copyrightYear":"2019","dateCreated":"2019-11-11T17:11:11\u002b00:00","datePublished":"2019-11-11T17:11:11\u002b00:00","dateModified":"2019-11-11T17:11:11\u002b00:00","keywords":["aws","CI","startup"],"mainEntityOfPage":"true","wordCount":"445"}]</script><meta name=author content="Nathan Yergler"><link href=https://github.com/nyergler rel=me><link href=https://instagram.com/nyergler rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="flex justify-between py-6 font-semibold sm:items-center sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Nathan R. Yergler</a></div><nav><ul class="flex flex-col list-none sm:flex-row"><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/about/ title="Oh hai.">Bio</a></li><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>Blog</a></li><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/prints/ title=Prints>Prints</a></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>Nathan R. Yergler</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/2019/11/11/using-ecr-images-with-elastic-beanstalk-and-codebuild/>Using ECR images with Elastic Beanstalk and CodeBuild</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Using ECR images with Elastic Beanstalk and CodeBuild</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2019-11-11 17:11:11 +0000 UTC">November 11, 2019</time></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="min-w-0 min-h-0 max-w-prose"><p>As I mentioned <a href=https://www.yergler.net/2019/10/17/continuous-integration-with-codebuild-and-codepipeline/>previously</a>, I&rsquo;ve been using CodePipeline and CodeBuild for
continuous integration and delivery on a new project. For the most part I&rsquo;ve
been happy with it, but ran into an issue last week that took some experimenting
to figure out.</p><p>In addition to CodePipeline and CodeBuild, we&rsquo;re also using <a href=https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/Welcome.html>Elastic
Beanstalk</a> for deploying our application. I first experimented with Elastic
Beanstalk when it was released, and at the time it had quite a few opinions
about how to build an application. When I took another look a few months ago,
though, I found that it has grown up considerably. The default model is still
dumping your code on an EC2 host and managing the autoscaling group, but it also
supports deploying arbitrary Docker images &mdash; both single images and ECS
clusters. The <a href=https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb-cli-codebuild.html>ability to use CodeBuild with Elastic Beanstalk</a> means you can
utilize the same CI pipeline regardless of whether you&rsquo;re deploying as the
result of a web hook or as a one off from the command line.</p><p>This was working great until we started using a custom Docker image, hosted in
the Elastic Container Registry (ECR), for our CodeBuild jobs. When we moved to
that image, one-off builds broke with an error indicating CodeBuild couldn&rsquo;t
pull the Docker image from ECR (&ldquo;Perhaps you need to login?&rdquo; The
error message helpfully suggested. Yes, perhaps.) This was pretty confusing,
since I was able to confirm that both one-off and pipeline builds were using the
same IAM Role, which had permission to fetch images from ECR (and was working
from the pipeline). The AWS documentation iterates <a href=https://docs.aws.amazon.com/codebuild/latest/userguide/sample-ecr.html>the permissions you need in
order to use ECR with CodeBuild</a>, and indeed, that role had the proper
permissions assigned.</p><p>As I experimented, though, I discovered that the issue was not the CodeBuild
role, but rather the <a href=https://docs.aws.amazon.com/AmazonECR/latest/userguide/security_iam_service-with-iam.html>ECR Repository Policy</a>. When executing CodeBuild as the
result of <code>eb deploy</code>, the ECR repository must be configured to allow image
pulls from the CodeBuild service. I suspect this is because <code>eb deploy</code> doesn&rsquo;t
execute as your existing CodeBuild project: it creates a new one with the source
and output set to S3, runs the build, and tears it down after collecting the
artifacts.</p><p>I was able to apply the policy with the following Terraform fragment:</p><pre><code>data &quot;aws_iam_policy_document&quot; &quot;ecr_policy&quot; {
  statement {
    sid    = &quot;CodebuildPullPolicy&quot;
    effect = &quot;Allow&quot;
    actions = [
      &quot;ecr:GetDownloadUrlForLayer&quot;,
      &quot;ecr:BatchGetImage&quot;,
      &quot;ecr:BatchCheckLayerAvailability&quot;,
    ]

    principals {
      type = &quot;Service&quot;
      identifiers = [
        &quot;codebuild.amazonaws.com&quot;,
      ]
    }
  }
}

resource &quot;aws_ecr_repository_policy&quot; &quot;build&quot; {
  repository = &quot;${aws_ecr_repository.build.name}&quot; # the name of your ECR repository
  policy = &quot;${data.aws_iam_policy_document.ecr_policy.json}&quot;
}
</code></pre><p>Once this was applied, Pipeline and command line builds both were able to pull the image.</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/2019/10/17/continuous-integration-with-codebuild-and-codepipeline/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Continuous Integration with CodeBuild and CodePipeline</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2019-10-17 15:08:36 +0000 UTC">October 17, 2019</time></span></span></a></span>
<span><a class="flex text-right group" href=/2019/12/06/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"></span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2019-12-06 18:08:22 +0000 UTC">December 6, 2019</time></span></span>
<span class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div class="absolute top-[110vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>Tags</a></li><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/categories/ title=Categories>Categories</a></li></ul></nav><div class="flex justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2022
Nathan Yergler</p></div></div></footer></div></body></html>